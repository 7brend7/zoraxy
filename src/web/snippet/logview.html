<!DOCTYPE html>
<html ng-app="App">
<head>
    <title>LogView | Zoraxy</title>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#4b75ff">
    <meta name="zoraxy.csrf.Token" content="{{.csrfToken}}">
    <link rel="icon" type="image/png" href="../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no">
    <link rel="stylesheet" href="../script/semantic/semantic.min.css">
    <script type="text/javascript" src="../script/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="../script/semantic/semantic.min.js"></script>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="darktheme.css">
    <style>
        .clickable{
            cursor: pointer;
        }
        .clickable:hover{
            opacity: 0.7;
        }

        /* Panel menu */
        .logfile_menu_btn{
            height: 2.8em !important;
            margin-top: 0.4em !important;
            margin-right: 0 !important;
        }

        /* Log file list */
        .logfile{
            padding-left: 1em !important;
            position: relative;
            padding-right: 1em !important;
        }

        .loglist{
            background-color: rgb(250, 250, 250);
        }

        .logfile .showing{
            position: absolute;
            top: 0.18em;
            right: 0em;
            margin-right: -0.4em;
            opacity: 0;
        }

        .logfile.active .showing{
            opacity: 1;
        }

        #logrender{
            width: 100% !important;
            height: calc(100% - 1.2em);
            min-height: calc(90vh - 1.2em) !important;
            border: 0px solid transparent !important;
            background-color: #252630;
            color: white;
            font-family: monospace;
            overflow-x: scroll !important;
            white-space: pre;
            resize: none;
            scrollbar-width: thin;
            font-size: 1.2em;
        }

        #logrender::selection{ 
            background:#3643bb; 
            color:white; 
        }

        body.darkTheme .loglist {
            background-color: #1b1c1d;
            color: #ffffff;
        }

        body.darkTheme .loglist .ui.header .content .sub.header {
            color: #bbbbbb;
        }

        body.darkTheme .loglist .ui.divider {
            border-color: #333333;
        }

        body.darkTheme .loglist .ui.accordion .title,
        body.darkTheme .loglist .ui.accordion .content {
            background-color: #1b1c1d;
            color: #ffffff;
        }

        body.darkTheme .loglist .ui.accordion .title:hover {
            background-color: #333333;
        }

        body.darkTheme .loglist .ui.list .item {
            color: #ffffff;
        }

        body.darkTheme .loglist .ui.list .item .content {
            color: #ffffff;
        }

        body.darkTheme .loglist .ui.list .item .showing {
            color: #ffffff;
        }

        body.darkTheme .loglist .ui.button.filterbtn {
            background-color: #333333;
            color: #ffffff;
        }

        body.darkTheme .loglist .ui.button.filterbtn:hover {
            background-color: #555555;
        }

        body.darkTheme .loglist .ui.toggle.checkbox label {
            color: #ffffff;
        }

        body.darkTheme .loglist small {
            color: #bbbbbb;
        }


        @media (min-width: 768px) {
            #logfileDropdown {
                margin-left: 0.4em !important;
            }

            .logfile_menu_btn{
                margin-left:0.4em !important;
            }

            #logfileDropdown{
                margin-left: 0.4em !important;
            }
        }
    </style>
</head>
<body>
    <link rel="stylesheet" href="../darktheme.css">
    <script src="../script/darktheme.js"></script>
    <br>
    <div class="ui container">
        <div class="ui stackable secondary menu">
            <div class="item" style="font-weight: bold;">
                Zoraxy LogView
            </div>
            <a class="item active panel_menu_btn" id="dashboardMenu">
                Dashboard
            </a>
            <a class="item panel_menu_btn" id="logViewMenu">
                Log View
            </a>
            <a class="item panel_menu_btn" id="settingsMenu">
                Settings
            </a>
        </div>
    </div>
    <div class="ui container">
        <div class="ui divider"></div>
        <div class="ui stackable secondary menu">
            <!-- Filter Dropdown -->
            <div class="ui selection dropdown" id="filterDropdown" style="margin-top:0.4em;">
                <div class="text">Select Filter</div>
                <i class="dropdown icon"></i>
                <div class="menu">
                    <div class="item" data-value="all"><i class="filter icon"></i> All</div>
                    <div class="item" data-value="system"><i class="blue info circle icon"></i> System</div>
                    <div class="item" data-value="request"><i class="green exchange icon"></i> Request</div>
                    <div class="item" data-value="error"><i class="red exclamation triangle icon"></i> Error</div>
                </div>
            </div>

            <!-- Log File Dropdown -->
            <div class="ui selection dropdown" id="logfileDropdown" style="margin-top: 0.4em; height: 2.8em;">
                <div class="text">Select Log File</div>
                <i class="dropdown icon"></i>
                <div class="menu" id="logfileDropdownMenu">
                    <!-- Log files will be populated here -->
                </div>
            </div>
            
            <!-- Download Button -->
            <button class="ui icon basic button logfile_menu_btn" id="downloadLogBtn" title="Download Current Log File">
                <i class="black download icon"></i>
            </button>

            <!-- Open in New Tab Button -->
            <button class="ui icon basic button logfile_menu_btn" onclick="openLogInNewTab();" title="Open in New Tab">
                <i class="external alternate icon"></i>
            </button>
        </div>
    </div>
    <br><br>
    <!-- Dashboard View -->
    <div id="dashboard" class="ui container subpanel">
        <h3 class="ui header">
            Dashboard
        </h3>
        <div class="ui divider"></div>
        <p>Welcome to LogVPro! Use the left menu to select a log file </p>
        <div id="analyzer">

        </div>
    </div>

    <!-- Log Viewer -->
    <div id="logviewer" class="ui container subpanel" style="display:none;">
        <textarea id="logrender" spellcheck="false" readonly="true">
Pick a log file from the menu to start debugging
        </textarea>
        <br><br>
        <div class="ui divider"></div>
        <div class="ui toggle checkbox">
            <input type="checkbox" id="enableAutoScroll" onchange="handleAutoScrollTicker(event, this.checked);">
            <label>Auto Refresh<br>
            <small>Refresh the viewing log every 10 seconds</small></label>
        </div>
        <div class="ui divider"></div>
        <small>Notes: Some log files might be huge. Make sure you have checked the log file size before opening</small>
    </div>

    <!-- Settings -->
    <div id="settings" class="ui container subpanel" style="display:none;">
        <h3 class="ui header">
            Settings
        </h3>
    </div> 

    <br>
    <div class="ui container">
        <div class="ui divider"></div>
        <small>Zoraxy LogView - Advance log viewer for Zoraxy log files</small>
        <br><br><br>
    </div>
</body>
<script>
    //LogView Implementation
    var currentFilter = "all";
    var currentOpenedLogURL = "";
    var currentLogFile = "";
    var autoscroll = false;

    $(".checkbox").checkbox();

    /* Menu Subpanel Switch */
    $(".subpanel").hide();
    $("#dashboard").show();
    $(".panel_menu_btn").on("click", function() {
        var id = $(this).attr("id");
        $(".subpanel").hide();
        $(".ui.menu .item").removeClass("active");
        $(this).addClass("active");
        if (id === "dashboardMenu") {
            $("#dashboard").show();
        } else if (id === "logViewMenu") {
            $("#logviewer").show();
        } else if (id === "settingsMenu") {
            $("#settings").show();
        }
    });

    /* Log file dropdown */
    function populateLogfileDropdown() {
        $.get("/api/log/list", function(data){
            let $menu = $("#logfileDropdownMenu");
            $menu.html("");
            for (let [key, value] of Object.entries(data)) {
                value.reverse();
                value.forEach(file => {
                    $menu.append(
                        `<div class="item" data-value="${file.Filename}" data-category="${key}">${file.Title} (${formatBytes(file.Filesize)})</div>`
                    );
                });
            }
            $('#logfileDropdown').dropdown('refresh');
        });
    }
    $('#logfileDropdown').dropdown({
        onChange: function(value, text, $choice) {
            if (value) {
                openLog(null, $choice.data('category'), value, currentFilter || "all");
            }
        }
    });
    populateLogfileDropdown();

    /* Filter dropdown */
    $('#filterDropdown').dropdown({
        onChange: function(value) {
            currentFilter = value;
            if (!currentLogFile) {
                return;
            }
            $(".filterbtn.active").removeClass("active");
            $(`.filterbtn[filter="${value}"]`).addClass("active");
            openLog(null, null, currentLogFile, currentFilter);
        }
    });

    // Set default filter to "error"
    $('#filterDropdown').dropdown('set selected', 'all');
    currentFilter = "all";

    /* Log download button */
    $("#downloadLogBtn").on("click", function() {
        if (!currentLogFile) {
            alert("Please select a log file first.");
            return;
        }
        if (!currentOpenedLogURL) {
            alert("No log file is currently opened.");
            return;
        }
        $.get(currentOpenedLogURL, function(data) {
            if (data.error !== undefined) {
                alert(data.error);
                return;
            }
            let blob = new Blob([data], {type: "text/plain"});
            let url = URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url;
            a.download = currentLogFile || "log.txt";
            document.body.appendChild(a);
            a.click();
            setTimeout(function() {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        });
    });


    function openLog(object, catergory, filename, filter="all"){
        $(".logfile.active").removeClass('active');
        $(object).addClass("active");
        currentLogFile = filename;
        currentOpenedLogURL = "/api/log/read?file=" + filename + "&filter=" + filter;
        $.get(currentOpenedLogURL, function(data){
            if (data.error !== undefined){
                alert(data.error);
                return;
            }
            renderLogWithCurrentFilter(data);
        });
    }
</script>
<script>
    function openLogInNewTab(){
        if (currentOpenedLogURL != ""){
            window.open(currentOpenedLogURL);
        }
    }

    function initLogList(){
        $("#logList").html("");
        $.get("/api/log/list", function(data){
            //console.log(data);
            for (let [key, value] of Object.entries(data)) {
                console.log(key, value);
                value.reverse(); //Default value was from oldest to newest
                var fileItemList = "";
                value.forEach(file => {
                    fileItemList += `<div class="item clickable logfile" onclick="openLog(this, '${key}','${file.Filename}');">
                            <i class="file outline icon"></i>
                            <div class="content">
                                ${file.Title} (${formatBytes(file.Filesize)})
                                <div class="showing"><i class="green chevron right icon"></i></div>
                            </div>
                        </div>`;
                })
                $("#logList").append(`<div class="title">
                    <i class="dropdown icon"></i>
                        ${key}
                    </div>
                    <div class="content">
                        <div class="ui list">
                            ${fileItemList}
                        </div>
                    </div>`);
            }

            $(".ui.accordion").accordion();
        });
    }
    initLogList();

    
    function formatBytes(x){
        var units = ['bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        let l = 0, n = parseInt(x, 10) || 0;
        while(n >= 1024 && ++l){
            n = n/1024;
        }
        return(n.toFixed(n < 10 && l > 0 ? 1 : 0) + ' ' + units[l]);
    }

    //Filter the log and render it to text area based on current filter choice
    function renderLogWithCurrentFilter(data){
        $("#logrender").val(data);
        var textarea = document.getElementById('logrender');
        textarea.scrollTop = textarea.scrollHeight;
    }

    /* Filter related functions */
    $(".filterbtn").on("click", function(evt){
        //Set filter type
        let filterType = $(this).attr("filter");
        currentFilter = (filterType);
        $(".filterbtn.active").removeClass("active");
        $(this).addClass('active');

        //Reload the log with filter
        if (currentOpenedLogURL != ""){
            $.get(currentOpenedLogURL, function(data){
                if (data.error !== undefined){
                    alert(data.error);
                    return;
                }
                renderLogWithCurrentFilter(data);
            }); 
        }
    });

    /* Auto scroll function */
    setInterval(function(){
        if (autoscroll){
            //Update the log and scroll to bottom
            if (currentOpenedLogURL != ""){
                $.get(currentOpenedLogURL, function(data){
                    if (data.error !== undefined){
                        console.log(data.error);
                        return;
                    }
                    renderLogWithCurrentFilter(data);
                }); 
            }
        }
    }, 10000);
    function handleAutoScrollTicker(event, checked){
        autoscroll = checked;
    }


    /* Log analyzer */
    /* --- Log Analyzer UI --- */
    $("#analyzer").html(`
        <div class="ui segment">
            <h4 class="ui header">Log Analytics</h4>
            <div class="ui divider"></div>
            <div class="ui grid">
                <div class="eight wide column">
                    <canvas id="requestTypePie"></canvas>
                </div>
                <div class="eight wide column" id="originCharts"></div>
            </div>
            <div class="ui divider"></div>
            <h5>Client IP Table</h5>
            <div style="max-height:300px;overflow:auto;">
                <table class="ui celled table" id="clientIpTable">
                    <thead>
                        <tr>
                            <th>Client IP</th>
                            <th>Requests</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    `);

    // Load Chart.js
    if (typeof Chart === "undefined") {
        var chartjs = document.createElement("script");
        chartjs.src = "https://cdn.jsdelivr.net/npm/chart.js";
        chartjs.onload = function() {
            setupLogAnalyzer();
        };
        document.head.appendChild(chartjs);
    } else {
        setupLogAnalyzer();
    }

    function setupLogAnalyzer() {
        // Add button to analyze current log
        if ($("#analyzeLogBtn").length === 0) {
            $("<button class='ui blue button' id='analyzeLogBtn' style='margin-bottom:1em;'>Analyze Current Log</button>")
                .insertBefore("#analyzer .ui.segment");
        }
        $("#analyzeLogBtn").off("click").on("click", function() {
            let log = $("#logrender").val();
            if (!log || log.indexOf("Pick a log file") !== -1) {
                alert("Please open a log file first.");
                return;
            }
            analyzeLog(log);
        });
    }

    function analyzeLog(log) {
        // Parse log lines
        let lines = log.split("\n").filter(l => l.trim().length > 0 && l[0] === "[");
        let reqTypeCount = {};
        let originDayCount = {};
        let clientIpCount = {};

        let reqTypeRegex = /\] ([A-Z]+) /;
        let originRegex = /\[origin:([^\]]+)\]/;
        let dateRegex = /^\[([0-9\-]+) /;
        let clientIpRegex = /\[client: ([^\]]+)\]/;
        lines.forEach(line => {
            // Request type
            let reqTypeMatch = line.match(reqTypeRegex);
            let reqType = reqTypeMatch ? reqTypeMatch[1] : "OTHER";
            reqTypeCount[reqType] = (reqTypeCount[reqType] || 0) + 1;

            // Origin
            let originMatch = line.match(originRegex);
            let origin = originMatch ? originMatch[1] : null;
            
            // Date
            let dateMatch = line.match(dateRegex);
            let date = dateMatch ? dateMatch[1] : null;

            // Skip if origin or date is unknown
            if (!origin || !date) return;

            // Per-origin per-day
            if (!originDayCount[origin]) originDayCount[origin] = {};
            originDayCount[origin][date] = (originDayCount[origin][date] || 0) + 1;

            // Client IP
            let ipMatch = line.match(clientIpRegex);
            let ip = ipMatch ? ipMatch[1] : "unknown";
            clientIpCount[ip] = (clientIpCount[ip] || 0) + 1;
        });

        // --- Pie Chart: Request Type Ratio ---
        let pieCtx = document.getElementById("requestTypePie").getContext("2d");
        if (window.requestTypePieChart) window.requestTypePieChart.destroy();
        window.requestTypePieChart = new Chart(pieCtx, {
            type: "pie",
            data: {
                labels: Object.keys(reqTypeCount),
                datasets: [{
                    data: Object.values(reqTypeCount),
                    backgroundColor: [
                        "#2185d0", "#21ba45", "#db2828", "#fbbd08", "#a333c8", "#00b5ad", "#b5cc18"
                    ]
                }]
            },
            options: {
                plugins: {
                    legend: { position: "bottom" }
                }
            }
        });

        // --- Histogram Charts: Requests per Host (Origin) per Day ---
        let $originCharts = $("#originCharts");
        $originCharts.html("");
        Object.keys(originDayCount).forEach((origin, idx) => {
            let chartId = "originChart_" + idx;
            $originCharts.append(`<div style="margin-bottom:2em;"><b>${origin}</b><canvas id="${chartId}" height="120"></canvas></div>`);
            let dayCounts = originDayCount[origin];
            let days = Object.keys(dayCounts).sort();
            let counts = days.map(d => dayCounts[d]);
            let ctx = document.getElementById(chartId).getContext("2d");
            new Chart(ctx, {
            type: "bar",
            data: {
                labels: days,
                datasets: [{
                label: "Requests",
                data: counts,
                backgroundColor: "#2185d0"
                }]
            },
            options: {
                plugins: {
                legend: { display: false }
                },
                scales: {
                x: { 
                    title: { display: true, text: "Date" },
                    grid: { display: false }
                },
                y: { 
                    title: { display: true, text: "Requests" }, 
                    beginAtZero: true,
                    grid: { display: true }
                }
                }
            }
            });
        });

        // --- Table: Client IPs ---
        let $tbody = $("#clientIpTable tbody");
        $tbody.html("");
        Object.entries(clientIpCount)
            .sort((a, b) => b[1] - a[1])
            .forEach(([ip, count]) => {
                $tbody.append(`<tr><td>${ip}</td><td>${count}</td></tr>`);
            });
    }
</script>
</html>